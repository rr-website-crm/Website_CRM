{% extends 'base.html' %}
{% load static %}

{% block title %}Assigned Jobs - CRM Portal{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1 class="dashboard-title">Assigned Jobs</h1>
    <p class="dashboard-subtitle">Jobs currently allocated to team members</p>
</div>

<!-- Statistics Cards -->
<div class="stats-grid" style="margin-bottom: 2rem;">
    <div class="stat-card" style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);">
        <div class="stat-value">{{ jobs.count }}</div>
        <div class="stat-label">Total Assigned</div>
    </div>
    
    <div class="stat-card" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
        <div class="stat-value">
            {% with allocated_count=0 %}
                {% for job in jobs %}
                    {% if job.status == 'allocated' %}
                        {% with allocated_count=allocated_count|add:1 %}{% endwith %}
                    {% endif %}
                {% endfor %}
                {{ allocated_count }}
            {% endwith %}
        </div>
        <div class="stat-label">Allocated</div>
    </div>
    
    <div class="stat-card" style="background: linear-gradient(135deg, #00BCD4 0%, #0097A7 100%);">
        <div class="stat-value">
            {% with progress_count=0 %}
                {% for job in jobs %}
                    {% if job.status == 'in_progress' %}
                        {% with progress_count=progress_count|add:1 %}{% endwith %}
                    {% endif %}
                {% endfor %}
                {{ progress_count }}
            {% endwith %}
        </div>
        <div class="stat-label">In Progress</div>
    </div>
</div>

<!-- Jobs Table -->
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2 class="card-title" style="margin: 0;">Assigned Jobs List</h2>
        <div style="display: flex; gap: 0.5rem;">
            <button onclick="filterStatus('all')" class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.875rem;">All</button>
            <button onclick="filterStatus('allocated')" class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Allocated</button>
            <button onclick="filterStatus('in_progress')" class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.875rem;">In Progress</button>
        </div>
    </div>
    <div class="card-body">
        {% if jobs %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>SL No</th>
                        <th>Job ID</th>
                        <th>Topic</th>
                        <th>Word Count</th>
                        <th>Category</th>
                        <th>Deadline</th>
                        <th>Allocated By</th>
                        <th>Allocated At</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="jobsTableBody">
                    {% for job in jobs %}
                    <tr data-status="{{ job.status }}">
                        <td>{{ forloop.counter }}</td>
                        <td><strong style="color: var(--primary);">{{ job.masking_id }}</strong></td>
                        <td>{{ job.topic|truncatewords:8 }}</td>
                        <td><strong>{{ job.word_count }}</strong></td>
                        <td>
                            <span class="status-tag" style="background-color: {% if job.job_category == 'IT' %}rgba(33, 150, 243, 0.2); color: #2196F3{% elif job.job_category == 'Finance' %}rgba(76, 175, 80, 0.2); color: #4CAF50{% else %}rgba(156, 39, 176, 0.2); color: #9C27B0{% endif %};">
                                {{ job.job_category }}
                            </span>
                        </td>
                        <td>
                            <div style="font-weight: 600;">{{ job.deadline|date:"d/m/Y" }}</div>
                            <div style="font-size: 0.875rem; opacity: 0.7;">{{ job.deadline|date:"H:i" }}</div>
                        </td>
                        <td>{{ job.allocated_by.get_full_name|default:"N/A" }}</td>
                        <td>
                            <div style="font-size: 0.875rem;">{{ job.allocated_at|date:"d/m/Y" }}</div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">{{ job.allocated_at|timesince }} ago</div>
                        </td>
                        <td>
                            <span class="status-tag status-{{ job.status }}">
                                {{ job.get_status_display }}
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <a href="{% url 'view_job_details' job.id %}" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem; text-decoration: none;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2"/>
                                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                    View
                                </a>
                                <a href="{% url 'allocate_job' job.id %}" class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.875rem; text-decoration: none;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2"/>
                                        <path d="M18.5 2.50001C18.8978 2.10219 19.4374 1.87869 20 1.87869C20.5626 1.87869 21.1022 2.10219 21.5 2.50001C21.8978 2.89784 22.1213 3.43741 22.1213 4.00001C22.1213 4.56262 21.8978 5.10219 21.5 5.50001L12 15L8 16L9 12L18.5 2.50001Z" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                    Edit
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="text-align: center; padding: 3rem; color: var(--text-color); opacity: 0.6;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 1rem; opacity: 0.5;">
                <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.7088 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18455 2.99721 7.13631 4.39828 5.49706C5.79935 3.85781 7.69279 2.71537 9.79619 2.24013C11.8996 1.76489 14.1003 1.98232 16.07 2.86" stroke="currentColor" stroke-width="2"/>
                <polyline points="22 4 12 14.01 9 11.01" stroke="currentColor" stroke-width="2"/>
            </svg>
            <p style="font-size: 1.1rem; font-weight: 500;">No assigned jobs</p>
        </div>
        {% endif %}
    </div>
</div>

<style>
    .card, .stat-card {
        animation: fadeInUp 0.5s ease-out;
    }
    
    .stat-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    }
    
    .data-table tbody tr {
        transition: all 0.3s ease;
    }
    
    .data-table tbody tr:hover {
        background-color: var(--hover-bg);
        transform: scale(1.01);
    }
</style>

<script>
function filterStatus(status) {
    const rows = document.querySelectorAll('#jobsTableBody tr');
    
    rows.forEach(row => {
        if (status === 'all') {
            row.style.display = '';
        } else {
            if (row.getAttribute('data-status') === status) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });
}
</script>
{% endblock %}