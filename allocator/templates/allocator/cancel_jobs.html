{% extends 'base.html' %}
{% load static %}

{% block title %}Cancel Jobs - CRM Portal{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1 class="dashboard-title">Cancel Jobs</h1>
    <p class="dashboard-subtitle">Manage and view cancelled jobs</p>
</div>

<!-- Statistics Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <div class="card" style="padding: 1.5rem; text-align: center; background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%); color: white;">
        <div style="font-size: 2.5rem; font-weight: 700;">{{ jobs.count }}</div>
        <div style="opacity: 0.9; margin-top: 0.5rem;">Total Cancelled</div>
    </div>
    
    <div class="card" style="padding: 1.5rem; text-align: center;">
        <div style="font-size: 2.5rem; font-weight: 700; color: #FF9800;">
            {% with this_month=0 %}
                {% for job in jobs %}
                    {% if job.updated_at.month == today_date.month %}
                        {% with this_month=this_month|add:1 %}{% endwith %}
                    {% endif %}
                {% endfor %}
                {{ this_month }}
            {% endwith %}
        </div>
        <div style="color: var(--text-color); opacity: 0.8; margin-top: 0.5rem;">This Month</div>
    </div>
    
    <div class="card" style="padding: 1.5rem; text-align: center;">
        <div style="font-size: 2.5rem; font-weight: 700; color: #2196F3;">
            {% with this_week=0 %}
                {% for job in jobs %}
                    {% if job.updated_at >= today_date|add:"-7 days" %}
                        {% with this_week=this_week|add:1 %}{% endwith %}
                    {% endif %}
                {% endfor %}
                {{ this_week }}
            {% endwith %}
        </div>
        <div style="color: var(--text-color); opacity: 0.8; margin-top: 0.5rem;">This Week</div>
    </div>
</div>

<!-- Jobs Table -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Cancelled Jobs List</h2>
    </div>
    <div class="card-body">
        {% if jobs %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>SL No</th>
                        <th>Job ID</th>
                        <th>Topic</th>
                        <th>Word Count</th>
                        <th>Category</th>
                        <th>Created By</th>
                        <th>Cancellation Reason</th>
                        <th>Cancelled On</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job in jobs %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td><strong style="color: #F44336;">{{ job.masking_id }}</strong></td>
                        <td>{{ job.topic|truncatewords:10 }}</td>
                        <td><strong>{{ job.word_count }}</strong></td>
                        <td>
                            <span class="status-tag" style="background-color: {% if job.job_category == 'IT' %}rgba(33, 150, 243, 0.2); color: #2196F3{% elif job.job_category == 'Finance' %}rgba(76, 175, 80, 0.2); color: #4CAF50{% else %}rgba(156, 39, 176, 0.2); color: #9C27B0{% endif %};">
                                {{ job.job_category }}
                            </span>
                        </td>
                        <td>{{ job.created_by.get_full_name }}</td>
                        <td>
                            {% if job.allocator_comment %}
                                <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ job.allocator_comment }}">
                                    {{ job.allocator_comment|truncatewords:15 }}
                                </div>
                            {% else %}
                                <span style="opacity: 0.5;">No reason provided</span>
                            {% endif %}
                        </td>
                        <td>
                            <div style="font-weight: 600;">{{ job.updated_at|date:"d/m/Y" }}</div>
                            <div style="font-size: 0.875rem; opacity: 0.7;">{{ job.updated_at|timesince }} ago</div>
                        </td>
                        <td>
                            <a href="{% url 'view_job_details' job.id %}" class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.875rem; text-decoration: none;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2"/>
                                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                View Details
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="text-align: center; padding: 3rem; color: var(--text-color); opacity: 0.6;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 1rem; opacity: 0.5;">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2"/>
                <line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2"/>
            </svg>
            <p style="font-size: 1.1rem; font-weight: 500;">No cancelled jobs</p>
            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Great! All jobs are either active or completed</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Cancel Job Modal -->
<div class="modal-overlay" id="cancelModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Cancel Job</h3>
            <button class="modal-close" onclick="closeModal('cancelModal')">&times;</button>
        </div>
        <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="job_id" id="cancelJobId">
            
            <div class="form-group">
                <label for="reason" class="form-label required">Cancellation Reason</label>
                <textarea id="reason" name="reason" class="form-control" rows="4" required placeholder="Please provide a reason for cancellation..."></textarea>
            </div>
            
            <div class="btn-group" style="justify-content: flex-end; margin-top: 1.5rem;">
                <button type="button" class="btn btn-outline" onclick="closeModal('cancelModal')">Close</button>
                <button type="submit" class="btn btn-primary" style="background-color: #F44336;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2"/>
                        <line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Cancel Job
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .card {
        animation: fadeInUp 0.5s ease-out;
    }
    
    .data-table tbody tr:hover {
        background-color: var(--hover-bg);
        transform: scale(1.01);
    }
</style>

<script>
function openCancelModal(jobId) {
    document.getElementById('cancelJobId').value = jobId;
    openModal('cancelModal');
}
</script>
{% endblock %}