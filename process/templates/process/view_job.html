<!-- process/templates/process/view_job.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}View Job - {{ job.job_id }} - Process{% endblock %}

{% block content %}
<div class="dashboard-header" style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 class="dashboard-title">Job: {{ job.job_id }}</h1>
            <p class="dashboard-subtitle">Process Team - Job Details</p>
        </div>
        <a href="{% url 'process_dashboard' %}" class="btn btn-outline">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Back to Dashboard
        </a>
    </div>
</div>

<!-- Job Information Card -->
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-header">
        <h3 class="card-title">Job Information</h3>
    </div>
    <div class="card-body">
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Job ID</label>
                <p style="font-family: monospace; font-size: 1.1rem; font-weight: 600; color: var(--primary);">
                    {{ job.job_id }}
                </p>
            </div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <p>
                    {% if job.status == 'allocated' %}
                    <span class="status-tag status-allocated">Allocated</span>
                    {% elif job.status == 'in_progress' %}
                    <span class="status-tag status-in-progress">In Progress</span>
                    {% elif job.status == 'submitted' %}
                    <span class="status-tag status-completed">Submitted</span>
                    {% else %}
                    <span class="status-tag">{{ job.get_status_display }}</span>
                    {% endif %}
                </p>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Topic</label>
                <p style="font-size: 1rem; line-height: 1.6;">{{ job.topic }}</p>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Word Count</label>
                <p style="font-size: 1.1rem; font-weight: 600;">{{ job.word_count }} words</p>
            </div>
            <div class="form-group">
                <label class="form-label">Deadline</label>
                <p style="font-size: 1.1rem; font-weight: 600; color: var(--accent);">
                    {{ job.deadline|date:"d M Y, H:i" }}
                </p>
            </div>
            <div class="form-group">
                <label class="form-label">Referencing</label>
                <p style="font-size: 1.1rem; font-weight: 600;">{{ job.referencing }}</p>
            </div>
        </div>
        
        <!-- Writer's Final File -->
        <div class="form-group" style="margin-top: 1.5rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
            <label class="form-label">Writer's Final File</label>
            {% if job.writer_final_file %}
            <a href="{{ job.writer_final_file.url }}" target="_blank" class="btn btn-primary" style="margin-top: 0.5rem;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Download Writer's File
            </a>
            <p style="margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.7;">
                Uploaded: {{ job.writer_uploaded_at|date:"d M Y, H:i" }}
            </p>
            {% else %}
            <p style="color: var(--accent); font-weight: 500;">Not uploaded yet</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Check Stage Submission -->
{% if not decoration_task %}
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-header">
        <h3 class="card-title">Check Stage - AI & Plagiarism Check</h3>
    </div>
    <div class="card-body">
        <form method="post" action="{% url 'submit_check_stage' job.job_id %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label required">AI File</label>
                    <input type="file" name="ai_file" class="form-control" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">Plagiarism File</label>
                    <input type="file" name="plag_file" class="form-control" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <polyline points="17 21 17 13 7 13 7 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <polyline points="7 3 7 8 15 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Submit Check Stage
            </button>
        </form>
    </div>
</div>

<!-- Final Stage Submission -->
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-header">
        <h3 class="card-title">Final Stage - Complete Submission</h3>
    </div>
    <div class="card-body">
        <form method="post" action="{% url 'submit_final_stage' job.job_id %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label required">Final File</label>
                    <input type="file" name="final_file" class="form-control" accept=".pdf,.doc,.docx" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">AI File</label>
                    <input type="file" name="ai_file" class="form-control" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label required">Plagiarism File</label>
                    <input type="file" name="plag_file" class="form-control" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Grammarly Report (Optional)</label>
                    <input type="file" name="grammarly_report" class="form-control" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Other Files (Optional)</label>
                <input type="file" name="other_files" class="form-control">
            </div>
            <button type="submit" class="btn btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                    <polyline points="20 6 9 17 4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Submit Final Stage
            </button>
        </form>
    </div>
</div>
{% endif %}

<!-- Decoration Stage (if assigned) -->
{% if decoration_task %}
<div class="card" style="margin-bottom: 2rem; border: 2px solid var(--accent);">
    <div class="card-header" style="background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%);">
        <h3 class="card-title">Decoration Stage</h3>
    </div>
    <div class="card-body">
        <form method="post" action="{% url 'submit_decoration' job.job_id %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label required">Final File</label>
                    <input type="file" name="final_file" class="form-control" accept=".pdf,.doc,.docx" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">AI File</label>
                    <input type="file" name="ai_file" class="form-control" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label required">Plagiarism File</label>
                    <input type="file" name="plag_file" class="form-control" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Other Files (Optional)</label>
                    <input type="file" name="other_files" class="form-control">
                </div>
            </div>
            <button type="submit" class="btn btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                    <polyline points="20 6 9 17 4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Submit Decoration
            </button>
        </form>
    </div>
</div>
{% endif %}

<!-- Previous Submissions -->
{% if submissions %}
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-header">
        <h3 class="card-title">Previous Submissions</h3>
    </div>
    <div class="card-body">
        {% for submission in submissions %}
        <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <h4 style="font-size: 1rem; font-weight: 600; color: var(--primary);">
                    {{ submission.get_stage_display }}
                </h4>
                <span style="font-size: 0.9rem; opacity: 0.7;">
                    {{ submission.submitted_at|date:"d M Y, H:i" }}
                </span>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                {% if submission.ai_file %}
                <a href="{{ submission.ai_file.url }}" target="_blank" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.9rem;">AI File</a>
                {% endif %}
                {% if submission.plag_file %}
                <a href="{{ submission.plag_file.url }}" target="_blank" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.9rem;">Plag File</a>
                {% endif %}
                {% if submission.final_file %}
                <a href="{{ submission.final_file.url }}" target="_blank" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.9rem;">Final File</a>
                {% endif %}
                {% if submission.grammarly_report %}
                <a href="{{ submission.grammarly_report.url }}" target="_blank" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.9rem;">Grammarly</a>
                {% endif %}
                {% if submission.other_files %}
                <a href="{{ submission.other_files.url }}" target="_blank" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.9rem;">Other Files</a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Comments Section -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Comments</h3>
    </div>
    <div class="card-body">
        <!-- Add Comment Form -->
        <form method="post" action="{% url 'add_comment' job.job_id %}" enctype="multipart/form-data" style="margin-bottom: 2rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
            {% csrf_token %}
            <div class="form-group">
                <label class="form-label">Add Comment</label>
                <textarea name="comment_text" class="form-control" rows="4" placeholder="Enter your comment (min 5 characters)..." style="resize: vertical;"></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Attachment (Optional)</label>
                    <input type="file" name="attachment" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Link (Optional)</label>
                    <input type="url" name="link" class="form-control" placeholder="https://example.com">
                </div>
            </div>
            <button type="submit" class="btn btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Add Comment
            </button>
        </form>
        
        <!-- Comments List -->
        <div style="max-height: 600px; overflow-y: auto;">
            {% for comment in comments %}
            <div class="comment-item" style="padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid var(--primary);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                    <div>
                        <strong style="color: var(--primary);">{{ comment.user.get_full_name }}</strong>
                        <span style="font-size: 0.85rem; opacity: 0.7; margin-left: 0.5rem;">
                            ({{ comment.user.employee_id }})
                        </span>
                    </div>
                    <span style="font-size: 0.85rem; opacity: 0.7;">
                        {{ comment.created_at|date:"d M Y, H:i" }}
                    </span>
                </div>
                
                <p style="line-height: 1.6; margin-bottom: 0.5rem;">{{ comment.text }}</p>
                
                {% if comment.attachment %}
                <a href="{{ comment.attachment.url }}" target="_blank" class="btn btn-outline" style="padding: 4px 10px; font-size: 0.85rem; margin-top: 0.5rem;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 4px;">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Attachment
                </a>
                {% endif %}
                
                {% if comment.link %}
                <a href="{{ comment.link }}" target="_blank" class="btn btn-outline" style="padding: 4px 10px; font-size: 0.85rem; margin-top: 0.5rem; margin-left: 0.5rem;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 4px;">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Link
                </a>
                {% endif %}
                
                {% if comment.user == user %}
                <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                    <button onclick="editComment({{ comment.id }}, '{{ comment.text|escapejs }}')" class="btn btn-secondary" style="padding: 4px 10px; font-size: 0.85rem;">Edit</button>
                    <form method="post" action="{% url 'delete_comment' comment.id %}" style="display: inline;" onsubmit="return confirm('Delete this comment?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline" style="padding: 4px 10px; font-size: 0.85rem; border-color: #F44336; color: #F44336;">Delete</button>
                    </form>
                </div>
                {% endif %}
            </div>
            {% empty %}
            <p style="text-align: center; opacity: 0.7; padding: 2rem;">No comments yet. Be the first to comment!</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Edit Comment Modal -->
<div class="modal-overlay" id="editCommentModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Comment</h3>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <form method="post" id="editCommentForm">
            {% csrf_token %}
            <div class="form-group">
                <label class="form-label">Comment Text</label>
                <textarea name="comment_text" id="editCommentText" class="form-control" rows="4" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Update Comment</button>
        </form>
    </div>
</div>

<script>
function editComment(commentId, currentText) {
    document.getElementById('editCommentText').value = currentText;
    document.getElementById('editCommentForm').action = `/process/comment/${commentId}/edit/`;
    document.getElementById('editCommentModal').classList.add('active');
}

function closeEditModal() {
    document.getElementById('editCommentModal').classList.remove('active');
}

// Close modal on overlay click
document.getElementById('editCommentModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditModal();
    }
});
</script>

<style>
.card {
    animation: fadeInUp 0.5s ease-out;
}

.comment-item {
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>
{% endblock %}