{% extends 'base.html' %}
{% load static %}
{% block title %}Create Job (Manual) - CRM Portal{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .form-card {
        background-color: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
    }
    
    .form-section-title {
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
    }
    
    .form-grid.single {
        grid-template-columns: 1fr;
    }
    
    .file-upload-area {
        border: 2px dashed rgba(255, 255, 255, 0.3);
        border-radius: var(--radius-md);
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(0, 0, 0, 0.2);
    }
    
    .file-upload-area:hover {
        border-color: var(--primary);
        background: rgba(var(--primary-rgb), 0.1);
    }
    
    .file-list {
        margin-top: 1rem;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        background: rgba(0, 0, 0, 0.3);
        border-radius: var(--radius-md);
        margin-bottom: 0.5rem;
    }
    
    .file-item-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
    }
    
    .file-remove-btn {
        background: #F44336;
        color: white;
        border: none;
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: 0.85rem;
    }
    
    .char-counter {
        text-align: right;
        font-size: 0.85rem;
        margin-top: 0.25rem;
        color: var(--text-color);
        opacity: 0.7;
    }
    
    .char-counter.error {
        color: #F44336;
    }
    
    .char-counter.success {
        color: #4CAF50;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .loading-overlay.active {
        display: flex;
    }
    
    .loading-content {
        text-align: center;
        color: white;
    }
    
    .spinner {
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        border-top: 4px solid var(--primary);
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

{% endblock %}

{% block content %}
<div class="dashboard-header" style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h1 class="dashboard-title">Create Job (Manual)</h1>
            <p class="dashboard-subtitle">Create a new job without AI summary generation</p>
        </div>
        <a href="{% url 'marketing_dashboard' %}" class="btn btn-outline">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 12H5M5 12L12 19M5 12L12 5"
                    stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Back to Dashboard
        </a>
    </div>
</div>

<div class="form-container">
    <form id="manualJobForm">
        {% csrf_token %}
        
        <!-- Basic Information Section -->
        <div class="form-card">
            <h2 class="form-section-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2"/>
                    <polyline points="14 2 14 8 20 8" stroke="currentColor" stroke-width="2"/>
                </svg>
                Basic Information
            </h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="jobId" class="form-label required">Job ID</label>
                    <input type="text" id="jobId" name="job_id" class="form-control" required 
                           placeholder="Enter unique job ID">
                    <small id="jobIdFeedback" style="display: block; margin-top: 0.5rem;"></small>
                </div>
                
                <div class="form-group">
                    <label for="topic" class="form-label required">Topic</label>
                    <input type="text" id="topic" name="topic" class="form-control" required 
                           placeholder="Enter job topic">
                </div>
            </div>
            
            <div class="form-grid single">
                <div class="form-group">
                    <label for="instruction" class="form-label required">Instruction</label>
                    <textarea id="instruction" name="instruction" class="form-control" rows="6" required 
                              placeholder="Enter detailed instructions (minimum 50 characters)"></textarea>
                    <div class="char-counter" id="charCounter">0 / 50 characters</div>
                </div>
            </div>
            
            <div class="form-grid single">
                <div class="form-group">
                    <label class="form-label">Attachments (Optional)</label>
                    <div class="file-upload-area" id="fileUploadArea">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin: 0 auto 1rem; opacity: 0.5;">
                            <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2"/>
                            <polyline points="17 8 12 3 7 8" stroke="currentColor" stroke-width="2"/>
                            <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <p style="margin: 0; color: var(--text-color); opacity: 0.7;">
                            Click to upload or drag and drop<br>
                            <small>PDF, DOCX, JPG, JPEG, PNG (Max 10 files, 10MB each)</small>
                        </p>
                        <input type="file" id="fileInput" name="attachments" multiple 
                               accept=".pdf,.docx,.jpg,.jpeg,.png" style="display: none;">
                    </div>
                    <div class="file-list" id="fileList"></div>
                </div>
            </div>
        </div>
        
        <!-- Job Details Section -->
        <div class="form-card">
            <h2 class="form-section-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                    <line x1="9" y1="9" x2="15" y2="9" stroke="currentColor" stroke-width="2"/>
                    <line x1="9" y1="12" x2="15" y2="12" stroke="currentColor" stroke-width="2"/>
                    <line x1="9" y1="15" x2="13" y2="15" stroke="currentColor" stroke-width="2"/>
                </svg>
                Job Details
            </h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="customer_id" class="form-label required">Customer</label>
                    <select id="customer_id" name="customer_id" class="form-control" required>
                        <option value="">Select Customer</option>
                        {% for customer in customers %}
                        <option value="{{ customer.customer_id }}">
                            {{ customer.customer_name }} ({{ customer.customer_email }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="word_count" class="form-label required">Word Count</label>
                    <input type="number" id="word_count" name="word_count" class="form-control" required 
                           min="1" placeholder="Enter word count" onchange="calculateSystemAmount()">
                </div>
                
                <div class="form-group">
                    <label for="referencing_style" class="form-label">Referencing Style</label>
                    <select id="referencing_style" name="referencing_style" class="form-control">
                        <option value="">Select Referencing Style</option>
                        {% for ref in referencing_styles %}
                        <option value="{{ ref.referencing_style }}">
                            {{ ref.referencing_style }} - {{ ref.used_in }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="writing_style" class="form-label">Writing Style</label>
                    <select id="writing_style" name="writing_style" class="form-control">
                        <option value="">Select Writing Style</option>
                        {% for writing in writing_styles %}
                        <option value="{{ writing.writing_style }}">{{ writing.writing_style }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="category" class="form-label required">Category</label>
                    <select id="category" name="category" class="form-control" required onchange="updateLevelOptions()">
                        <option value="">Select Category</option>
                        {% for value, label in category_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="level" class="form-label required">Level</label>
                    <select id="level" name="level" class="form-control" required onchange="calculateSystemAmount()">
                        <option value="">Select Level</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="software" class="form-label">Software (if applicable)</label>
                    <textarea id="software" name="software" class="form-control" rows="2" 
                              placeholder="e.g., Python 3.9, MATLAB R2021b"></textarea>
                </div>
            </div>
        </div>
        
        <!-- Project Configuration Section -->
        <div class="form-card">
            <h2 class="form-section-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 16V8C20.9996 7.64927 20.9071 7.30481 20.7315 7.00116C20.556 6.69751 20.3037 6.44536 20 6.27L13 2.27C12.696 2.09446 12.3511 2.00205 12 2.00205C11.6489 2.00205 11.304 2.09446 11 2.27L4 6.27C3.69626 6.44536 3.44398 6.69751 3.26846 7.00116C3.09294 7.30481 3.00036 7.64927 3 8V16C3.00036 16.3507 3.09294 16.6952 3.26846 16.9988C3.44398 17.3025 3.69626 17.5546 4 17.73L11 21.73C11.304 21.9055 11.6489 21.9979 12 21.9979C12.3511 21.9979 12.696 21.9055 13 21.73L20 17.73C20.3037 17.5546 20.556 17.3025 20.7315 16.9988C20.9071 16.6952 20.9996 16.3507 21 16Z" stroke="currentColor" stroke-width="2"/>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96" stroke="currentColor" stroke-width="2"/>
                    <line x1="12" y1="22.08" x2="12" y2="12" stroke="currentColor" stroke-width="2"/>
                </svg>
                Project Configuration
            </h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="template" class="form-label required">Template</label>
                    <select id="template" name="template" class="form-control" required>
                        <option value="">Select Template</option>
                        {% for template in templates %}
                        <option value="{{ template.id }}">{{ template.template_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="project_group" class="form-label required">Project Group</label>
                    <select id="project_group" name="project_group" class="form-control" required>
                        <option value="">Select Project Group</option>
                        {% for group in project_groups %}
                        <option value="{{ group.id }}">{{ group.project_group_name }} ({{ group.project_group_prefix }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="expected_deadline" class="form-label required">Expected Deadline (IST)</label>
                    <input type="datetime-local" id="expected_deadline" name="expected_deadline" 
                           class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="strict_deadline" class="form-label required">Strict Deadline (IST)</label>
                    <input type="datetime-local" id="strict_deadline" name="strict_deadline" 
                           class="form-control" required>
                    <small style="color: rgba(255,255,255,0.6);">Must be at least 24 hours from now</small>
                </div>
            </div>
        </div>
        
        <!-- Pricing Section -->
        <div class="form-card">
            <h2 class="form-section-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <line x1="12" y1="1" x2="12" y2="23" stroke="currentColor" stroke-width="2"/>
                    <path d="M17 5H9.5C8.57174 5 7.6815 5.36875 7.02513 6.02513C6.36875 6.6815 6 7.57174 6 8.5C6 9.42826 6.36875 10.3185 7.02513 10.9749C7.6815 11.6313 8.57174 12 9.5 12H14.5C15.4283 12 16.3185 12.3687 16.9749 13.0251C17.6313 13.6815 18 14.5717 18 15.5C18 16.4283 17.6313 17.3185 16.9749 17.9749C16.3185 18.6313 15.4283 19 14.5 19H6" stroke="currentColor" stroke-width="2"/>
                </svg>
                Pricing
            </h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="price_per_word_display" class="form-label">Price Per Word (from Price Master)</label>
                    <input type="text" id="price_per_word_display" class="form-control" readonly 
                           placeholder="Select category and level">
                </div>
                
                <div class="form-group">
                    <label for="system_expected_amount_display" class="form-label">System Expected Amount</label>
                    <input type="text" id="system_expected_amount_display" class="form-control" readonly 
                           placeholder="Auto-calculated">
                </div>
                
                <div class="form-group">
                    <label for="amount" class="form-label required">Amount</label>
                    <input type="number" id="amount" name="amount" class="form-control" required 
                           min="0" step="0.01" placeholder="Enter negotiated amount">
                </div>
            </div>
        </div>
        
        <!-- Submit Section -->
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <a href="{% url 'marketing_dashboard' %}" class="btn btn-outline">Cancel</a>
            <button type="submit" class="btn btn-primary">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <polyline points="9 11 12 14 22 4" stroke="currentColor" stroke-width="2"/>
                    <path d="M21 12V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16" stroke="currentColor" stroke-width="2"/>
                </svg>
                Create Job
            </button>
        </div>
    </form>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h3 id="loadingText">Creating Job...</h3>
        <p id="loadingSubtext">Please wait</p>
    </div>
</div>

<script>
const CSRF_TOKEN = '{{ csrf_token }}';
const PRICE_MAP = {{ price_map|safe }};
let uploadedFiles = [];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initializeFileUpload();
    initializeCharCounter();
    initializeJobIdValidation();
    initializeFormHandler();
});

// File Upload
function initializeFileUpload() {
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('fileInput');
    
    fileUploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);
    
    // Drag and drop
    fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.style.borderColor = 'var(--primary)';
    });
    
    fileUploadArea.addEventListener('dragleave', () => {
        fileUploadArea.style.borderColor = '';
    });
    
    fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.style.borderColor = '';
        handleFileSelect({ target: { files: e.dataTransfer.files } });
    });
}

function handleFileSelect(e) {
    const files = Array.from(e.target.files);
    const allowedTypes = ['pdf', 'docx', 'jpg', 'jpeg', 'png'];
    const maxSize = 10 * 1024 * 1024;
    
    if (uploadedFiles.length + files.length > 10) {
        showNotification('Maximum 10 files allowed', 'error');
        return;
    }
    
    files.forEach(file => {
        const ext = file.name.split('.').pop().toLowerCase();
        
        if (uploadedFiles.some(f => f.name === file.name)) {
            showNotification(`${file.name} already added`, 'error');
            return;
        }
        
        if (!allowedTypes.includes(ext)) {
            showNotification(`File type .${ext} not allowed`, 'error');
            return;
        }
        
        if (file.size > maxSize) {
            showNotification(`${file.name} exceeds 10MB`, 'error');
            return;
        }
        
        uploadedFiles.push(file);
    });
    
    renderFileList();
}

function renderFileList() {
    const fileList = document.getElementById('fileList');
    
    if (uploadedFiles.length === 0) {
        fileList.innerHTML = '';
        return;
    }
    
    fileList.innerHTML = uploadedFiles.map((file, index) => `
        <div class="file-item">
            <div class="file-item-info">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M13 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V9L13 2Z" stroke="currentColor" stroke-width="2"/>
                </svg>
                <span>${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
            </div>
            <button type="button" class="file-remove-btn" onclick="removeFile(${index})">Remove</button>
        </div>
    `).join('');
}

function removeFile(index) {
    uploadedFiles.splice(index, 1);
    renderFileList();
}

// Character Counter
function initializeCharCounter() {
    const instruction = document.getElementById('instruction');
    const counter = document.getElementById('charCounter');
    
    instruction.addEventListener('input', () => {
        const length = instruction.value.length;
        counter.textContent = `${length} / 50 characters`;
        
        if (length < 50) {
            counter.classList.add('error');
            counter.classList.remove('success');
        } else {
            counter.classList.add('success');
            counter.classList.remove('error');
        }
    });
}

// Job ID Validation
function initializeJobIdValidation() {
    const jobId = document.getElementById('jobId');
    const feedback = document.getElementById('jobIdFeedback');
    let timeout;
    
    jobId.addEventListener('input', () => {
        clearTimeout(timeout);
        timeout = setTimeout(async () => {
            const value = jobId.value.trim();
            
            if (!value) {
                feedback.textContent = '';
                return;
            }
            
            try {
                const response = await fetch('{% url "check_job_id_unique" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({ job_id: value })
                });
                
                const data = await response.json();
                
                if (data.unique) {
                    feedback.textContent = '✓ Job ID is available';
                    feedback.style.color = '#4CAF50';
                    jobId.style.borderColor = '#4CAF50';
                } else {
                    feedback.textContent = '✗ ' + data.message;
                    feedback.style.color = '#F44336';
                    jobId.style.borderColor = '#F44336';
                }
            } catch (error) {
                console.error('Error checking job ID:', error);
            }
        }, 500);
    });
}

// Level Options
function getCategoryKey(value) {
    return (value || '').toUpperCase();
}

function getLevelKey(value) {
    return (value || '').toLowerCase();
}

function updateLevelOptions() {
    const category = document.getElementById('category').value;
    const levelSelect = document.getElementById('level');
    const categoryKey = getCategoryKey(category);
    const levelMap = PRICE_MAP[categoryKey] || {};
    
    levelSelect.innerHTML = '<option value="">Select Level</option>';
    levelSelect.disabled = Object.keys(levelMap).length === 0;
    
    Object.entries(levelMap).forEach(([levelKey, info]) => {
        const option = document.createElement('option');
        option.value = levelKey;
        option.textContent = info.label || levelKey;
        levelSelect.appendChild(option);
    });
    
    calculateSystemAmount();
}

// Calculate System Amount
function calculateSystemAmount() {
    const category = document.getElementById('category').value;
    const level = document.getElementById('level').value;
    const wordCount = document.getElementById('word_count').value;
    const displayEl = document.getElementById('system_expected_amount_display');
    const priceDisplayEl = document.getElementById('price_per_word_display');
    
    if (!category) {
        priceDisplayEl.value = '';
        displayEl.value = '';
        return;
    }
    
    const levelData = (PRICE_MAP[getCategoryKey(category)] || {})[getLevelKey(level)];
    if (!levelData) {
        priceDisplayEl.value = 'Unavailable';
        displayEl.value = '';
        return;
    }
    
    const pricePerWord = Number(levelData.price) || 0;
    priceDisplayEl.value = pricePerWord ? `${formatCurrency(pricePerWord)} / word` : 'Unavailable';
    
    if (!wordCount || parseInt(wordCount, 10) <= 0) {
        displayEl.value = '';
        return;
    }
    
    const expectedAmount = pricePerWord * parseFloat(wordCount);
    displayEl.value = formatCurrency(expectedAmount);
}

function formatCurrency(amount) {
    const numericAmount = Number(amount) || 0;
    try {
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            maximumFractionDigits: 2
        }).format(numericAmount);
    } catch (error) {
        return `₹${numericAmount.toFixed(2)}`;
    }
}

// Form Handler
function initializeFormHandler() {
    const form = document.getElementById('manualJobForm');
    form.addEventListener('submit', handleFormSubmit);
}

async function handleFormSubmit(e) {
    e.preventDefault();
    
    // Validate deadline
    const strictDeadline = new Date(document.getElementById('strict_deadline').value);
    const now = new Date();
    const minDeadline = new Date(now.getTime() + (24 * 60 * 60 * 1000));
    
    if (strictDeadline < minDeadline) {
        showNotification('Strict deadline must be at least 24 hours from now', 'error');
        return;
    }
    
    showLoading('Creating Job...', 'Please wait');
    
    try {
        const formData = new FormData();
        
        // Add all form fields
        formData.append('job_id', document.getElementById('jobId').value.trim());
        formData.append('instruction', document.getElementById('instruction').value.trim());
        formData.append('topic', document.getElementById('topic').value.trim());
        formData.append('customer_id', document.getElementById('customer_id').value);
        formData.append('word_count', document.getElementById('word_count').value);
        formData.append('referencing_style', document.getElementById('referencing_style').value);
        formData.append('writing_style', document.getElementById('writing_style').value);
        formData.append('category', document.getElementById('category').value);
        formData.append('level', document.getElementById('level').value);
        formData.append('software', document.getElementById('software').value.trim());
        formData.append('template', document.getElementById('template').value);
        formData.append('project_group', document.getElementById('project_group').value);
        formData.append('expected_deadline', document.getElementById('expected_deadline').value);
        formData.append('strict_deadline', document.getElementById('strict_deadline').value);
        formData.append('amount', document.getElementById('amount').value);
        
        // Add files
        uploadedFiles.forEach(file => {
            formData.append('attachments', file);
        });
        
        const response = await fetch('{% url "submit_manual_job" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': CSRF_TOKEN
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => {
                window.location.href = data.redirect;
            }, 1500);
        } else {
            hideLoading();
            if (data.errors && Array.isArray(data.errors)) {
                data.errors.forEach(error => showNotification(error, 'error'));
            } else {
                showNotification(data.errors || 'Failed to create job', 'error');
            }
        }
    } catch (error) {
        hideLoading();
        console.error('Error submitting form:', error);
        showNotification('An error occurred while creating the job', 'error');
    }
}

// Utility Functions
function showLoading(title, subtitle) {
    const overlay = document.getElementById('loadingOverlay');
    document.getElementById('loadingText').textContent = title;
    document.getElementById('loadingSubtext').textContent = subtitle;
    overlay.classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : '#2196F3'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    `;
    notification.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="background: none; border: none; color: white; cursor: pointer; font-size: 20px; padding: 0;">
                &times;
            </button>
        </div>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

</script>

{% endblock %}
